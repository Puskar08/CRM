@model IEnumerable<CRM.Models.TransactionViewModel>

@{
    ViewData["Title"] = "Clients";
}
<style>
    #loginIdSuggestions {
        max-height: 200px;
        overflow-y: auto;
        @* width: 100%; *@
    }
</style>
<style>
    .status-tag {
        display: inline-block;
        padding: 0 10px;
        font-size: 12px;
        line-height: 20px;
        border-radius: 25px;
        font-family: "Roboto", sans-serif;
        margin: 0 4px;
        border: 1px solid transparent;
    }

    /* Different colors for different statuses */
    .status-approved {
        border-color: #a1e6a1;
        background-color: #e6ffe6;
        color: #0f730c;
    }

    .status-rejected {
        border-color: #ffb3b3;
        background-color: #ffe6e6;
        color: #d9534f;
    }

    .status-pending {
        border-color: #ffe6a1;
        background-color: #fff8e6;
        color: #c27c00;
    }

    .status-review {
        border-color: #b3d1ff;
        background-color: #e6f0ff;
        color: #004085;
    }
</style>


<div class="page">

    <!-- Modal -->
    <div class="modal fade" id="TransactionModal" tabindex="-1" aria-labelledby="TransactionModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="TransactionModalLabel">Add Transaction</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal" id="transactionForm"
                        action="@Url.Action("AddTransaction", "Transaction")" method="post">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="loginId" class="form-label">Login ID</label>
                                <input type="text" class="form-control" id="loginId" name="loginId" required
                                    autocomplete="off" />
                                <ul id="loginIdSuggestions" class="list-group position-absolute"
                                    style="z-index: 1000; display: none;"></ul>
                            </div>
                            <div class="col-md-6">
                                <label for="fee" class="form-label">Transaction Type</label>
                                <select class="form-select" id="transactionType" name="transactionType" required>
                                    <option value="Deposit">Deposit</option>
                                    <option value="Withdraw">Withdraw</option>
                                </select>
                            </div>

                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="amount" class="form-label">Amount</label>
                                <input type="number" class="form-control roundable" id="amount" name="amount" min="0.00"
                                    value="0.00" step="0.01" required />
                            </div>
                            <div class="col-md-6">
                                <label for="fee" class="form-label">Fee</label>
                                <input type="number" class="form-control roundable" id="fee" name="fee" min="0.00"
                                    value="0.00" step="0.01" required />
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="transactionNote" class="form-label">Transaction Note</label>
                                <input type="text" class="form-control" id="transactionNote" name="transactionNote" />
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="submitTransaction" class="btn btn-primary">Submit</button>
                    <button type="button" id="submitAndApproveTransaction" class="btn btn-success">Submit &
                        Approve</button>
                </div>
            </div>
        </div>
    </div>

    <div
        class="page-header d-flex justify-content-between align-items-center mb-3 p-3 border-bottom bg-white shadow-sm rounded">
        <h5 class="mb-0">Transactions</h5>
        <div class="page-actions d-flex gap-2">
            <!-- Button trigger modal -->
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#TransactionModal">
                Create Transaction
            </button>
        </div>
    </div>
    <div class="page-body">
        <table>
            <thead>
                <tr>
                    <th>Transaction ID</th>
                    <th>Login</th>
                    <th>Client</th>
                    <th>Method</th>
                    <th>Amount</th>
                    <th>Fee</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>@item.TransactionId</td>
                        <td>@item.Login</td>
                        <td>@item.UserName</td>
                        <td>@item.TransactionType / Card Debit</td>
                        <td>@item.Amount</td>
                        <td>@item.Fee</td>
                        <td>
                            @if (item.ApprovalStatus == 1)
                            {
                                <span class="status-tag status-approved">Approved</span>
                            }
                            else if (item.ApprovalStatus == 2)
                            {
                                <span class="status-tag status-rejected">Rejected</span>
                            }
                            else
                            {
                                <span class="status-tag status-pending">Pending</span>
                            }
                        </td>
                        <td>@item.TransactionDate.ToString("yyyy-MM-dd HH:mm:ss")</td>
                        <td>
                            @if (item.ApprovalStatus == 0)
                            {
                                <button class="review status-tag status-review">Review</button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const loginIdInput = document.getElementById('loginId');
        const suggestionsList = document.getElementById('loginIdSuggestions');

        loginIdInput.addEventListener('input', function () {
            const query = this.value;

            if (query.length < 2) {
                suggestionsList.style.display = 'none';
                return;
            }

            fetch(`/Transaction/GetSuggestions?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    suggestionsList.innerHTML = '';
                    if (data.length > 0) {
                        data.forEach(user => {
                            const listItem = document.createElement('li');
                            listItem.className = 'list-group-item list-group-item-action';
                            listItem.textContent = `${user.mt5LoginID}-${user.name}-(${user.email})`;
                            listItem.addEventListener('click', function () {
                                loginIdInput.value = user.mt5LoginID;
                                suggestionsList.style.display = 'none';
                            });
                            suggestionsList.appendChild(listItem);
                        });
                        suggestionsList.style.display = 'block';
                    } else {
                        suggestionsList.style.display = 'none';
                    }
                })
                .catch(error => console.error('Error fetching suggestions:', error));
        });

        document.addEventListener('click', function (event) {
            if (!loginIdInput.contains(event.target) && !suggestionsList.contains(event.target)) {
                suggestionsList.style.display = 'none';
            }
        });

        const roundableInputs = document.querySelectorAll('.roundable');
        roundableInputs.forEach(input => {
            input.addEventListener('change', () => {
                let value = parseFloat(input.value);
                if (!isNaN(value)) {
                    input.value = value.toFixed(2);
                }
            });
        });

        function addTransaction(actionType) {
            debugger;
            const form = document.querySelector('#transactionForm');
            const formData = new FormData(form);
            formData.append('actionType', actionType);

            fetch(form.action, {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    const responseData = response.json();
                    debugger;
                    if (response.ok) {
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'success',
                            title: 'Success!',
                            text: responseData.message || "Transaction completed successfully.",
                            showConfirmButton: false,
                            timer: 3000,
                            timerProgressBar: true
                        });
                        // Optionally, you can reset the form or close the modal here
                        $('#TransactionModal').modal('hide');
                    } else {
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'error',
                            title: 'Error!',
                            text: responseData.message || "Transaction failed.",
                            showConfirmButton: false,
                            timer: 3000,
                            timerProgressBar: true
                        });
                    }
                })
                .catch(error => {
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'error',
                        title: 'Error!',
                        text: 'An unexpected error occurred.',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true
                    });
                });
        }
        //submitTransaction
        document.getElementById('submitTransaction').addEventListener('click', function () {
            addTransaction('submit');
        });
        //submitAndApproveTransaction
        document.getElementById('submitAndApproveTransaction').addEventListener('click', function () {
            addTransaction('submitAndApprove');
        });

        document.querySelectorAll('.review').forEach(button => {
            button.addEventListener('click', function () {
                debugger;
                const row = this.closest('tr');
                const transactionId = row.cells[0].textContent;

                Swal.fire({
                    title: 'Review Transaction',
                    text: `Do you want to approve or reject transaction ID ${transactionId}?`,
                    showDenyButton: true,
                    showCancelButton: true,
                    confirmButtonText: 'Approve',
                    denyButtonText: 'Reject',
                }).then((result) => {
                    if (result.isConfirmed) {
                        debugger;
                        updateTransactionStatus(parseInt(transactionId), 1); // Approve
                    } else if (result.isDenied) {
                        updateTransactionStatus(parseInt(transactionId), 2); // Reject
                    }
                });
            });
        });

        function updateTransactionStatus(transactionId, action) {
            fetch(`/Transaction/UpdateTransactionStatus`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ transactionId: transactionId, approvalStatus: action })
            })
                .then(response => {
                    const responseData = response.json();
                    if (response.ok) {
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'success',
                            title: 'Success!',
                            text: responseData.message || "Transaction status updated successfully.",
                            showConfirmButton: false,
                            timer: 3000,
                            timerProgressBar: true
                        }).then(() => {
                            location.reload(); // Reload the page to reflect changes
                        });
                    } else {
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'error',
                            title: 'Error!',
                            text: responseData.message || "Failed to update transaction status.",
                            showConfirmButton: false,
                            timer: 3000,
                            timerProgressBar: true
                        });
                    }
                })
                .catch(error => {
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'error',
                        title: 'Error!',
                        text: 'An unexpected error occurred.',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true
                    });
                });
        }
    });
</script>
